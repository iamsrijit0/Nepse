name: Simple Daily Diagnostic

# This is a simplified workflow for beginners
# It runs the diagnostic script daily after market close

on:
  # Run every weekday at 6 PM NPT (12:45 UTC)
  schedule:
    - cron: '45 12 * * 1-5'
  
  # Allow manual run from Actions tab
  workflow_dispatch:

jobs:
  run-analysis:
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Get the code
    - name: Get code
      uses: actions/checkout@v4
    
    # Step 2: Setup Python (without cache to avoid requirements.txt error)
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    # Step 3: Install required packages directly
    - name: Install packages
      run: |
        pip install --upgrade pip
        pip install pandas==2.1.4 numpy==1.26.2 requests==2.31.0
    
    # Step 4: Run the diagnostic script
    - name: Run diagnostic
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python multi_symbol_diagnostic.py
    
    # Step 5: Save the results back to GitHub
    - name: Save results
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Add all CSV results
        git add diagnostic_results.csv 2>/dev/null || true
        git add diagnostic_results_*.csv 2>/dev/null || true
        
        # Commit only if there are changes
        if ! git diff --staged --quiet; then
          git commit -m "ğŸ” Daily diagnostic results - $(date +'%Y-%m-%d %H:%M UTC')"
          git push
          echo "âœ… Results committed to repository"
        else
          echo "â„¹ï¸ No changes to commit"
        fi
    
    # Step 6: Save results as downloadable file (backup)
    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: diagnostic-results-${{ github.run_number }}
        path: diagnostic_results*.csv
        retention-days: 90
